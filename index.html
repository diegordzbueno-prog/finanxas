<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#0B0D14">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Finanxas">
  <meta name="description" content="Control financiero personal">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="icon" type="image/png" href="icon-192.png">
  <title>Finanxas</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    ::-webkit-scrollbar { display: none; }
    html, body { 
      background: #0B0D14; color: #E2E8F0; 
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      min-height: 100vh; min-height: 100dvh;
      overscroll-behavior: none;
    }
    input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.7); }
    
    /* Loading screen */
    #loading {
      position: fixed; inset: 0; background: #0B0D14; z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    #loading h1 {
      font-size: 32px; font-weight: 700;
      background: linear-gradient(135deg, #22D3EE, #818CF8);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    #loading p { color: #475569; font-size: 13px; margin-top: 8px; }
    .loading-spinner {
      width: 32px; height: 32px; border: 3px solid #1E2030; border-top-color: #22D3EE;
      border-radius: 50%; animation: spin 0.8s linear infinite; margin-top: 24px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
    @keyframes slideUp { from { transform: translateY(100%) } to { transform: translateY(0) } }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-20px) } to { opacity: 1; transform: translateY(0) } }
    /* Tap feedback */
    button:active, [data-tap]:active { transform: scale(0.96); opacity: 0.8; }
    button { transition: transform 0.1s, opacity 0.1s; }
    .tx-row:active { background: #1A1D2799 !important; }
  </style>
</head>
<body>
  <div id="loading">
    <h1>Finanxas</h1>
    <p>Tu control financiero ðŸ’ª</p>
    <div class="loading-spinner"></div>
  </div>
  <div id="app"></div>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Google API client -->
  <script src="https://apis.google.com/js/api.js" async defer></script>

  <script type="module">
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FINANXAS v2.0 â€” Full PWA + Google Drive Sync
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â”€â”€â”€ CONFIG: Replace with your own credentials â”€â”€â”€
    const CONFIG = {
      GOOGLE_CLIENT_ID: '149847431256-pi7aculkr3ampqcijf9ot8p1gtdg3pag.apps.googleusercontent.com',
      GOOGLE_API_KEY: 'AIzaSyDwT18V6fUvjjWwrKd9swK4FSJ8D7Or_GE',
      SCOPES: 'https://www.googleapis.com/auth/drive.appdata',
      DRIVE_FILENAME: 'finanxas_backup.json',
    };

    // â”€â”€â”€ Constants â”€â”€â”€
    const CURRENCIES = { MXN: { symbol: '$', name: 'Pesos', flag: 'ðŸ‡²ðŸ‡½' }, USD: { symbol: '$', name: 'DÃ³lares', flag: 'ðŸ‡ºðŸ‡¸' }, EUR: { symbol: 'â‚¬', name: 'Euros', flag: 'ðŸ‡ªðŸ‡º' } };
    const MONTHS = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    const FREQUENCIES = [
      { id: 'daily', label: 'Diario' },
      { id: 'weekly', label: 'Semanal' },
      { id: 'biweekly', label: 'Quincenal' },
      { id: 'monthly', label: 'Mensual' },
      { id: 'yearly', label: 'Anual' },
    ];

    const DEFAULT_CATEGORIES = {
      expense: [
        { id: 'food', name: 'Comida', icon: 'ðŸ”', color: '#FF6B6B' },
        { id: 'transport', name: 'Transporte', icon: 'ðŸš—', color: '#4ECDC4' },
        { id: 'entertainment', name: 'Entret.', icon: 'ðŸŽ®', color: '#A78BFA' },
        { id: 'services', name: 'Servicios', icon: 'ðŸ’¡', color: '#FBBF24' },
        { id: 'health', name: 'Salud', icon: 'ðŸ¥', color: '#34D399' },
        { id: 'shopping', name: 'Compras', icon: 'ðŸ›’', color: '#F472B6' },
        { id: 'home', name: 'Hogar', icon: 'ðŸ ', color: '#60A5FA' },
        { id: 'other_exp', name: 'Otros', icon: 'ðŸ“¦', color: '#9CA3AF' },
      ],
      income: [
        { id: 'trading_gold', name: 'Trading Gold', icon: 'ðŸ¥‡', color: '#FFD700' },
        { id: 'trading_sp500', name: 'Trading S&P500', icon: 'ðŸ“ˆ', color: '#10B981' },
        { id: 'trading_crypto', name: 'Crypto', icon: 'â‚¿', color: '#F7931A' },
        { id: 'ftmo_payout', name: 'FTMO Payout', icon: 'ðŸ’°', color: '#22D3EE' },
        { id: 'forex', name: 'Forex', icon: 'ðŸ’±', color: '#818CF8' },
        { id: 'salary', name: 'Salario/Otros', icon: 'ðŸ’µ', color: '#6EE7B7' },
        { id: 'other_inc', name: 'Otros Ingresos', icon: 'ðŸŽ', color: '#D1D5DB' },
      ],
    };

    // â”€â”€â”€ Storage â”€â”€â”€
    const STORAGE_KEY = 'finanxas_data_v1';
    const loadLocal = () => { try { const r = localStorage.getItem(STORAGE_KEY); return r ? JSON.parse(r) : null; } catch(e) { return null; } };
    const saveLocal = (data) => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e) {} };

    // â”€â”€â”€ Google Drive Module â”€â”€â”€
    const GDrive = {
      tokenClient: null, accessToken: null, isReady: false,
      async init() {
        return new Promise((resolve) => {
          const checkReady = setInterval(() => {
            if (window.google?.accounts?.oauth2 && window.gapi) {
              clearInterval(checkReady);
              gapi.load('client', async () => {
                await gapi.client.init({ apiKey: CONFIG.GOOGLE_API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] });
                GDrive.tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CONFIG.GOOGLE_CLIENT_ID, scope: CONFIG.SCOPES, callback: (resp) => { if (resp.error) return; GDrive.accessToken = resp.access_token; GDrive.isReady = true; } });
                resolve(true);
              });
            }
          }, 200);
          setTimeout(() => { clearInterval(checkReady); resolve(false); }, 10000);
        });
      },
      requestAccess() {
        return new Promise((resolve) => {
          if (!GDrive.tokenClient) { resolve(false); return; }
          GDrive.tokenClient.callback = (resp) => { if (resp.error) { resolve(false); return; } GDrive.accessToken = resp.access_token; GDrive.isReady = true; resolve(true); };
          if (GDrive.accessToken) { GDrive.tokenClient.requestAccessToken({ prompt: '' }); } else { GDrive.tokenClient.requestAccessToken({ prompt: 'consent' }); }
        });
      },
      async findFile() { try { const resp = await gapi.client.drive.files.list({ spaces: 'appDataFolder', q: `name='${CONFIG.DRIVE_FILENAME}'`, fields: 'files(id, name, modifiedTime)', pageSize: 1 }); return resp.result.files?.[0] || null; } catch(e) { return null; } },
      async readFile(fileId) { try { const resp = await gapi.client.drive.files.get({ fileId, alt: 'media' }); return typeof resp.result === 'string' ? JSON.parse(resp.result) : resp.result; } catch(e) { return null; } },
      async saveFile(data) {
        try {
          const existing = await GDrive.findFile();
          const boundary = '-------finanxas';
          const metadata = { name: CONFIG.DRIVE_FILENAME, mimeType: 'application/json', ...(existing ? {} : { parents: ['appDataFolder'] }) };
          const body = `--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${JSON.stringify(metadata)}\r\n--${boundary}\r\nContent-Type: application/json\r\n\r\n${JSON.stringify(data)}\r\n--${boundary}--`;
          const url = existing ? `https://www.googleapis.com/upload/drive/v3/files/${existing.id}?uploadType=multipart` : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
          const resp = await fetch(url, { method: existing ? 'PATCH' : 'POST', headers: { 'Authorization': `Bearer ${GDrive.accessToken}`, 'Content-Type': `multipart/related; boundary=${boundary}` }, body });
          return resp.ok;
        } catch(e) { return false; }
      },
      async loadFromDrive() { if (!GDrive.isReady) return null; const file = await GDrive.findFile(); if (!file) return null; return await GDrive.readFile(file.id); },
      async saveToDrive(data) { if (!GDrive.isReady) return false; return await GDrive.saveFile({ ...data, lastSync: new Date().toISOString(), app: 'Finanxas' }); },
      disconnect() { if (GDrive.accessToken) { google.accounts.oauth2.revoke(GDrive.accessToken); GDrive.accessToken = null; GDrive.isReady = false; } }
    };

    // â”€â”€â”€ Recurring Processing â”€â”€â”€
    const processRecurring = (recurring, transactions) => {
      const todayStr = new Date().toISOString().split('T')[0];
      let newTxs = [];
      const updatedRecurring = recurring.map(r => {
        if (!r.active) return r;
        const lastApplied = r.lastApplied || r.startDate;
        const getNext = (from) => {
          const d = new Date(from + 'T12:00:00');
          if (r.frequency === 'daily') d.setDate(d.getDate() + 1);
          else if (r.frequency === 'weekly') d.setDate(d.getDate() + 7);
          else if (r.frequency === 'biweekly') d.setDate(d.getDate() + 14);
          else if (r.frequency === 'monthly') d.setMonth(d.getMonth() + 1);
          else if (r.frequency === 'yearly') d.setFullYear(d.getFullYear() + 1);
          return d.toISOString().split('T')[0];
        };
        let next = getNext(lastApplied); let updated = { ...r };
        while (next <= todayStr) { const txId = `rec_${r.id}_${next}`; if (!transactions.find(t => t.id === txId)) { newTxs.push({ id: txId, type: r.type, amount: r.amount, category: r.category, currency: r.currency, date: next, note: `${r.note} ðŸ”„`, fromRecurring: r.id }); } updated.lastApplied = next; next = getNext(next); }
        return updated;
      });
      return { updatedRecurring, newTxs };
    };

    // â”€â”€â”€ Utility â”€â”€â”€
    const fmt = (amount, currency) => { const c = CURRENCIES[currency] || CURRENCIES.MXN; return `${c.symbol}${Math.abs(amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`; };
    const fmtShort = (amount, currency) => { const c = CURRENCIES[currency] || CURRENCIES.MXN; const a = Math.abs(amount); if (a >= 1000000) return `${c.symbol}${(a/1000000).toFixed(1)}M`; if (a >= 10000) return `${c.symbol}${(a/1000).toFixed(1)}k`; return fmt(amount, currency); };
    const getMonthTxs = (txs, m, y, cur) => txs.filter(t => { const d = new Date(t.date + 'T12:00:00'); return d.getMonth() === m && d.getFullYear() === y && t.currency === cur; });

    // â”€â”€â”€ App State â”€â”€â”€
    let state = {};
    const initState = () => {
      const saved = loadLocal();
      const recurring = saved?.recurring || []; const transactions = saved?.transactions || [];
      const { updatedRecurring, newTxs } = processRecurring(recurring, transactions);
      return { transactions: [...transactions, ...newTxs], categories: saved?.categories || DEFAULT_CATEGORIES, budgets: saved?.budgets || {}, recurring: updatedRecurring, view: 'dashboard', modal: null, editTx: null, month: new Date().getMonth(), year: new Date().getFullYear(), currency: 'MXN', toast: null, driveStatus: 'disconnected', lastSync: saved?.lastSync || null };
    };
    const update = (changes) => { state = { ...state, ...changes }; saveLocal({ transactions: state.transactions, categories: state.categories, budgets: state.budgets, recurring: state.recurring, lastSync: state.lastSync }); render(); };
    const showToast = (message, type = 'success') => { update({ toast: { message, type } }); setTimeout(() => update({ toast: null }), 3000); };

    // â”€â”€â”€ Google Drive Sync Functions â”€â”€â”€
    const connectDrive = async () => { update({ driveStatus: 'connecting' }); const ok = await GDrive.requestAccess(); if (ok) { update({ driveStatus: 'connected' }); showToast('Conectado a Google Drive'); await syncWithDrive(); } else { update({ driveStatus: 'disconnected' }); showToast('Error al conectar', 'error'); } };
    const syncWithDrive = async () => {
      if (!GDrive.isReady) return; update({ driveStatus: 'syncing' });
      try {
        const driveData = await GDrive.loadFromDrive();
        if (driveData) { const driveTime = new Date(driveData.lastSync || 0).getTime(); const localTime = new Date(state.lastSync || 0).getTime();
          if (driveTime > localTime) { const driveTxIds = new Set(driveData.transactions?.map(t => t.id) || []); const localOnly = state.transactions.filter(t => !driveTxIds.has(t.id)); const merged = [...(driveData.transactions || []), ...localOnly]; update({ transactions: merged, categories: driveData.categories || state.categories, budgets: driveData.budgets || state.budgets, recurring: driveData.recurring || state.recurring, driveStatus: 'connected', lastSync: new Date().toISOString() }); showToast('Datos sincronizados desde Drive'); await GDrive.saveToDrive({ transactions: merged, categories: state.categories, budgets: state.budgets, recurring: state.recurring, lastSync: new Date().toISOString() }); return; }
        }
        const ok = await GDrive.saveToDrive({ transactions: state.transactions, categories: state.categories, budgets: state.budgets, recurring: state.recurring, lastSync: new Date().toISOString() }); update({ driveStatus: 'connected', lastSync: new Date().toISOString() }); showToast(ok ? 'Respaldo guardado en Drive' : 'Error al guardar', ok ? 'success' : 'error');
      } catch(e) { update({ driveStatus: 'connected' }); showToast('Error de sincronizaciÃ³n', 'error'); }
    };
    const disconnectDrive = () => { GDrive.disconnect(); update({ driveStatus: 'disconnected' }); showToast('Desconectado de Google Drive'); };
    let syncTimeout = null;
    const autoSync = () => { if (!GDrive.isReady) return; clearTimeout(syncTimeout); syncTimeout = setTimeout(() => syncWithDrive(), 5000); };

    // â”€â”€â”€ Rendering â”€â”€â”€
    const el = (tag, attrs = {}, ...children) => {
      const e = document.createElement(tag);
      Object.entries(attrs).forEach(([k, v]) => {
        if (k === 'style' && typeof v === 'object') Object.assign(e.style, v);
        else if (k.startsWith('on')) e.addEventListener(k.slice(2).toLowerCase(), v);
        else if (k === 'className') e.className = v;
        else e.setAttribute(k, v);
      });
      children.flat(Infinity).forEach(c => { if (c == null || c === false) return; e.appendChild(typeof c === 'string' || typeof c === 'number' ? document.createTextNode(c) : c); });
      return e;
    };

    // â”€â”€â”€ Toast â”€â”€â”€
    const renderToast = () => {
      if (!state.toast) return '';
      const colors = { success: '#059669', error: '#DC2626', info: '#2563EB' };
      const icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸' };
      return el('div', { style: { position: 'fixed', top: 'calc(env(safe-area-inset-top, 20px) + 8px)', left: '50%', transform: 'translateX(-50%)', padding: '10px 20px', borderRadius: '14px', zIndex: '9999', background: colors[state.toast.type] || colors.info, color: '#fff', fontSize: '13px', fontWeight: '700', boxShadow: '0 8px 32px rgba(0,0,0,0.5)', animation: 'slideDown 0.3s ease', whiteSpace: 'nowrap' } }, `${icons[state.toast.type] || ''} ${state.toast.message}`);
    };

    // â”€â”€â”€ Donut SVG â”€â”€â”€
    const donutSVG = (segments, size = 80, totalAmount = '', currency = '') => {
      const total = segments.reduce((s, g) => s + g.value, 0) || 1;
      const r = (size - 14) / 2, cx = size/2, cy = size/2; let cum = -90;
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('width', size); svg.setAttribute('height', size);
      segments.filter(s => s.value > 0).forEach(seg => {
        const angle = (seg.value / total) * 360;
        const s1 = cum * Math.PI / 180, s2 = (cum + angle) * Math.PI / 180;
        cum += angle;
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', `M ${cx} ${cy} L ${cx+r*Math.cos(s1)} ${cy+r*Math.sin(s1)} A ${r} ${r} 0 ${angle>180?1:0} 1 ${cx+r*Math.cos(s2)} ${cy+r*Math.sin(s2)} Z`);
        path.setAttribute('fill', seg.color); path.setAttribute('opacity', '0.9');
        svg.appendChild(path);
      });
      const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      circle.setAttribute('cx', cx); circle.setAttribute('cy', cy); circle.setAttribute('r', r*0.55); circle.setAttribute('fill', '#0F1117');
      svg.appendChild(circle);
      // Center label
      if (totalAmount) {
        const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        txt.setAttribute('x', cx); txt.setAttribute('y', cy + 1);
        txt.setAttribute('text-anchor', 'middle'); txt.setAttribute('dominant-baseline', 'middle');
        txt.setAttribute('fill', '#94A3B8'); txt.setAttribute('font-size', size < 100 ? '9' : '11');
        txt.setAttribute('font-weight', '700'); txt.setAttribute('font-family', 'DM Sans, sans-serif');
        txt.textContent = totalAmount;
        svg.appendChild(txt);
      }
      return svg;
    };

    // â”€â”€â”€ Bar Chart â”€â”€â”€
    const barChart = (data, color, height = 80) => {
      const max = Math.max(...data.map(d => d.value), 1);
      return el('div', { style: { display: 'flex', alignItems: 'flex-end', gap: '3px', height: height+'px' } },
        data.map(d => el('div', { style: { flex: '1', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '3px' } },
          el('div', { style: { width: '100%', maxWidth: '28px', borderRadius: '4px 4px 0 0', height: Math.max((d.value/max)*(height-20), 2) + 'px', background: `linear-gradient(180deg, ${color}, ${color}77)`, transition: 'height 0.4s' } }),
          el('span', { style: { fontSize: '10px', color: '#4B5563' } }, d.label)
        ))
      );
    };

    // â”€â”€â”€ Shared Styles â”€â”€â”€
    const cardStyle = { background: '#13151E', borderRadius: '16px', padding: '16px', border: '1px solid #1E2030' };
    const inputStyles = { width: '100%', padding: '12px 14px', background: '#1A1D27', border: '1px solid #2A2D3A', borderRadius: '12px', color: '#E2E8F0', fontSize: '15px', outline: 'none', boxSizing: 'border-box' };
    const btnStyle = (bg, color, extra = {}) => ({ padding: '12px 16px', borderRadius: '12px', border: 'none', cursor: 'pointer', fontWeight: '600', fontSize: '14px', background: bg, color, transition: 'all 0.15s', ...extra });

    // â”€â”€â”€ Modal Base (Bottom Sheet style) â”€â”€â”€
    const renderModal = (title, content) => {
      const overlay = el('div', { onClick: () => update({ modal: null, editTx: null }), style: { position: 'fixed', inset: '0', background: 'rgba(0,0,0,0.65)', backdropFilter: 'blur(12px)', display: 'flex', alignItems: 'flex-end', justifyContent: 'center', zIndex: '1000' } });
      const sheet = el('div', { onClick: (e) => e.stopPropagation(), style: { background: '#13151E', borderRadius: '24px 24px 0 0', padding: '8px 24px calc(env(safe-area-inset-bottom, 16px) + 16px)', width: '100%', maxWidth: '500px', maxHeight: '88vh', overflowY: 'auto', animation: 'slideUp 0.3s ease-out', border: '1px solid #1E2030', borderBottom: 'none', transform: 'translateY(0)', transition: 'transform 0.15s ease' } },
        el('div', { style: { width: '36px', height: '4px', borderRadius: '2px', background: '#2A2D3A', margin: '0 auto 16px' } }),
        el('div', { style: { fontSize: '18px', fontWeight: '700', color: '#F1F5F9', marginBottom: '20px' } }, title),
        content
      );
      // Swipe-to-dismiss
      let startY = 0, currentY = 0, isDragging = false;
      sheet.addEventListener('touchstart', (e) => { if (sheet.scrollTop <= 0) { startY = e.touches[0].clientY; isDragging = true; } }, { passive: true });
      sheet.addEventListener('touchmove', (e) => { if (!isDragging) return; currentY = e.touches[0].clientY - startY; if (currentY > 0) { sheet.style.transform = `translateY(${currentY}px)`; sheet.style.transition = 'none'; } }, { passive: true });
      sheet.addEventListener('touchend', () => { if (!isDragging) return; isDragging = false; sheet.style.transition = 'transform 0.25s ease'; if (currentY > 120) { sheet.style.transform = 'translateY(100%)'; setTimeout(() => update({ modal: null, editTx: null }), 200); } else { sheet.style.transform = 'translateY(0)'; } currentY = 0; }, { passive: true });
      overlay.appendChild(sheet); return overlay;
    };

    // â”€â”€â”€ Header (FIXED: safe area + cleaner layout) â”€â”€â”€
    const renderHeader = () => {
      return el('div', { style: { padding: 'calc(env(safe-area-inset-top, 47px) + 8px) 20px 14px', background: '#0B0D14', position: 'sticky', top: '0', zIndex: '100' } },
        el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '14px' } },
          el('div', { style: { display: 'flex', alignItems: 'center', gap: '10px' } },
            el('span', { style: { fontSize: '20px', fontWeight: '700', background: 'linear-gradient(135deg, #22D3EE, #818CF8)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' } }, 'Finanxas'),
            el('button', { onClick: () => state.driveStatus === 'connected' ? syncWithDrive() : update({ modal: 'settings' }), style: { padding: '4px 10px', borderRadius: '20px', border: 'none', cursor: 'pointer', fontSize: '11px', fontWeight: '600', background: state.driveStatus === 'connected' ? '#34D39920' : state.driveStatus === 'syncing' ? '#FBBF2420' : '#1A1D27', color: state.driveStatus === 'connected' ? '#34D399' : state.driveStatus === 'syncing' ? '#FBBF24' : '#475569', display: 'flex', alignItems: 'center', gap: '4px', animation: state.driveStatus === 'syncing' ? 'spin 1s linear infinite' : 'none' } }, state.driveStatus === 'connected' ? 'â˜ï¸ Sync' : state.driveStatus === 'syncing' ? 'â³' : 'â˜ï¸')
          ),
          el('div', { style: { display: 'flex', gap: '3px', background: '#1A1D27', borderRadius: '20px', padding: '3px' } },
            ...Object.entries(CURRENCIES).map(([key, val]) => el('button', { onClick: () => update({ currency: key }), style: { padding: '5px 10px', borderRadius: '18px', border: 'none', cursor: 'pointer', fontSize: '12px', fontWeight: '600', background: state.currency === key ? '#22D3EE18' : 'transparent', color: state.currency === key ? '#22D3EE' : '#3B3F4E', transition: 'all 0.15s' } }, `${val.flag} ${key}`))
          )
        ),
        el('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', justifyContent: 'center' } },
          el('button', { onClick: () => { const m = state.month === 0 ? 11 : state.month - 1; const y = state.month === 0 ? state.year - 1 : state.year; update({ month: m, year: y }); }, style: { width: '44px', height: '44px', borderRadius: '14px', border: '1px solid #1E2030', background: '#13151E', color: '#94A3B8', cursor: 'pointer', fontSize: '18px', display: 'flex', alignItems: 'center', justifyContent: 'center' } }, 'â€¹'),
          el('div', { style: { fontSize: '15px', fontWeight: '700', color: '#E2E8F0', minWidth: '120px', textAlign: 'center' } }, `${MONTHS[state.month]} ${state.year}`),
          el('button', { onClick: () => { const m = state.month === 11 ? 0 : state.month + 1; const y = state.month === 11 ? state.year + 1 : state.year; update({ month: m, year: y }); }, style: { width: '44px', height: '44px', borderRadius: '14px', border: '1px solid #1E2030', background: '#13151E', color: '#94A3B8', cursor: 'pointer', fontSize: '18px', display: 'flex', alignItems: 'center', justifyContent: 'center' } }, 'â€º')
        )
      );
    };

    // â”€â”€â”€ Dashboard (REDESIGNED: hero balance + compact categories) â”€â”€â”€
    const renderDashboard = () => {
      const txs = getMonthTxs(state.transactions, state.month, state.year, state.currency);
      const inc = txs.filter(t => t.type === 'income').reduce((s,t) => s+t.amount, 0);
      const exp = txs.filter(t => t.type === 'expense').reduce((s,t) => s+t.amount, 0);
      const bal = inc - exp;

      const expByCat = state.categories.expense.map(c => { const v = txs.filter(t=>t.type==='expense'&&t.category===c.id).reduce((s,t)=>s+t.amount,0); return { ...c, value: v, pct: exp ? Math.round(v/exp*100) : 0 }; }).filter(c=>c.value>0).sort((a,b)=>b.value-a.value);
      const incByCat = state.categories.income.map(c => { const v = txs.filter(t=>t.type==='income'&&t.category===c.id).reduce((s,t)=>s+t.amount,0); return { ...c, value: v, pct: inc ? Math.round(v/inc*100) : 0 }; }).filter(c=>c.value>0).sort((a,b)=>b.value-a.value);
      const monthData = Array.from({length:6},(_,i) => { let m = state.month-5+i, y = state.year; if (m<0) { m+=12; y-=1; } const mt = getMonthTxs(state.transactions,m,y,state.currency); return { label: MONTHS[m], income: mt.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0), expense: mt.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0) }; });
      const allCats = [...state.categories.expense, ...state.categories.income];
      const recentTxs = txs.sort((a,b) => new Date(b.date)-new Date(a.date)).slice(0, 6);

      return el('div', { style: { display: 'flex', flexDirection: 'column', gap: '14px' } },

        // â”€â”€ Balance Hero Card â”€â”€
        el('div', { style: { ...cardStyle, padding: '20px', textAlign: 'center', background: 'linear-gradient(135deg, #13151E 0%, #171A24 100%)' } },
          el('div', { style: { fontSize: '12px', color: '#64748B', fontWeight: '500', marginBottom: '4px', letterSpacing: '0.5px', textTransform: 'uppercase' } }, 'Balance del mes'),
          el('div', { style: { fontSize: '32px', fontWeight: '800', color: bal >= 0 ? '#34D399' : '#FF6B6B', letterSpacing: '-1px' } }, `${bal<0?'-':''}${fmt(bal, state.currency)}`),
          el('div', { style: { display: 'flex', justifyContent: 'center', gap: '24px', marginTop: '14px' } },
            el('div', { style: { textAlign: 'center' } }, el('div', { style: { fontSize: '11px', color: '#4B5563', marginBottom: '2px' } }, 'Ingresos'), el('div', { style: { fontSize: '15px', fontWeight: '700', color: '#34D399' } }, `+${fmtShort(inc, state.currency)}`)),
            el('div', { style: { width: '1px', background: '#1E2030' } }),
            el('div', { style: { textAlign: 'center' } }, el('div', { style: { fontSize: '11px', color: '#4B5563', marginBottom: '2px' } }, 'Gastos'), el('div', { style: { fontSize: '15px', fontWeight: '700', color: '#FF6B6B' } }, `-${fmtShort(exp, state.currency)}`)),
          )
        ),

        // â”€â”€ Category Breakdown (side by side, smaller donuts) â”€â”€
        el('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' } },
          ...[
            { title: 'Gastos', cats: expByCat, empty: 'ðŸ¤‘', emptyMsg: 'Sin gastos', total: fmtShort(exp, state.currency) },
            { title: 'Ingresos', cats: incByCat, empty: 'ðŸ“­', emptyMsg: 'Sin ingresos', total: fmtShort(inc, state.currency) },
          ].map(section => {
            const card = el('div', { style: { ...cardStyle, padding: '14px' } },
              el('div', { style: { fontSize: '12px', color: '#94A3B8', fontWeight: '600', marginBottom: '10px' } }, section.title)
            );
            if (section.cats.length) {
              card.appendChild(el('div', { style: { display: 'flex', justifyContent: 'center', marginBottom: '10px' } }, donutSVG(section.cats, 80, section.total)));
              section.cats.slice(0,3).forEach(c => {
                card.appendChild(el('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '5px' } },
                  el('div', { style: { display: 'flex', alignItems: 'center', gap: '5px', overflow: 'hidden' } },
                    el('div', { style: { width: '6px', height: '6px', borderRadius: '50%', background: c.color, flexShrink: '0' } }),
                    el('span', { style: { fontSize: '11px', color: '#CBD5E1', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, `${c.icon} ${c.name}`)
                  ),
                  el('span', { style: { fontSize: '10px', color: '#4B5563', flexShrink: '0' } }, fmtShort(c.value, state.currency))
                ));
              });
            } else {
              card.appendChild(el('div', { style: { textAlign: 'center', padding: '20px 0' } },
                el('div', { style: { fontSize: '28px', color: '#2A2D3A' } }, section.empty),
                el('div', { style: { fontSize: '11px', color: '#3B3F4E', marginTop: '4px' } }, section.emptyMsg)
              ));
            }
            return card;
          })
        ),

        // â”€â”€ 6 Month Overview â”€â”€
        el('div', { style: { ...cardStyle, padding: '14px' } },
          el('div', { style: { fontSize: '12px', color: '#94A3B8', fontWeight: '600', marginBottom: '10px' } }, 'Ãšltimos 6 meses'),
          el('div', { style: { display: 'flex', gap: '12px' } },
            el('div', { style: { flex: '1' } }, el('div', { style: { fontSize: '9px', color: '#34D399', marginBottom: '4px', fontWeight: '600' } }, 'Ingresos'), barChart(monthData.map(d => ({ label: d.label, value: d.income })), '#34D399')),
            el('div', { style: { flex: '1' } }, el('div', { style: { fontSize: '9px', color: '#FF6B6B', marginBottom: '4px', fontWeight: '600' } }, 'Gastos'), barChart(monthData.map(d => ({ label: d.label, value: d.expense })), '#FF6B6B'))
          )
        ),

        // â”€â”€ Recent Transactions â”€â”€
        el('div', { style: { ...cardStyle } },
          el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' } },
            el('span', { style: { fontSize: '12px', color: '#94A3B8', fontWeight: '600' } }, 'Recientes'),
            txs.length > 0 ? el('button', { onClick: () => update({ view: 'transactions' }), style: { background: 'none', border: 'none', color: '#22D3EE', fontSize: '12px', cursor: 'pointer', fontWeight: '600' } }, 'Ver todo â†’') : null
          ),
          ...(recentTxs.length === 0
            ? [el('div', { style: { textAlign: 'center', padding: '28px 0' } }, el('div', { style: { fontSize: '36px', marginBottom: '6px' } }, 'âœ¨'), el('div', { style: { fontSize: '13px', color: '#3B3F4E' } }, 'Toca + para registrar tu primer movimiento'))]
            : recentTxs.map((tx, i) => {
                const cat = allCats.find(c => c.id === tx.category) || { icon: 'â“', name: '?', color: '#666' };
                return el('div', { className: 'tx-row', onClick: () => update({ modal: 'transaction', editTx: tx }), style: { display: 'flex', alignItems: 'center', padding: '10px 0', borderBottom: i < recentTxs.length-1 ? '1px solid #1A1D27' : 'none', cursor: 'pointer', borderRadius: '8px', transition: 'background 0.1s' } },
                  el('div', { style: { width: '38px', height: '38px', borderRadius: '12px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '18px', background: cat.color+'15', marginRight: '12px', flexShrink: '0' } }, cat.icon),
                  el('div', { style: { flex: '1', minWidth: '0' } },
                    el('div', { style: { fontSize: '13px', color: '#E2E8F0', fontWeight: '500' } }, cat.name),
                    el('div', { style: { fontSize: '11px', color: '#3B3F4E', marginTop: '1px' } }, tx.note || new Date(tx.date+'T12:00:00').toLocaleDateString('es-MX', { day: 'numeric', month: 'short' }))
                  ),
                  el('div', { style: { fontSize: '14px', fontWeight: '700', color: tx.type==='income' ? '#34D399' : '#FF6B6B' } }, `${tx.type==='income'?'+':'-'}${fmt(tx.amount, tx.currency)}`)
                );
              })
          )
        )
      );
    };

    // â”€â”€â”€ Transactions List (grouped by day) â”€â”€â”€
    const renderTransactions = () => {
      const txs = getMonthTxs(state.transactions, state.month, state.year, state.currency).sort((a,b) => new Date(b.date)-new Date(a.date));
      const grouped = {}; txs.forEach(t => { if (!grouped[t.date]) grouped[t.date] = []; grouped[t.date].push(t); });
      const allCats = [...state.categories.expense, ...state.categories.income];
      if (!Object.keys(grouped).length) return el('div', { style: { ...cardStyle, textAlign: 'center', padding: '48px 20px' } }, el('div', { style: { fontSize: '40px', marginBottom: '8px' } }, 'ðŸ“­'), el('div', { style: { fontSize: '14px', color: '#3B3F4E' } }, 'Sin movimientos este mes'));
      return el('div', { style: { display: 'flex', flexDirection: 'column', gap: '10px' } },
        ...Object.entries(grouped).map(([date, items]) => {
          const dayTot = items.reduce((s,t) => s + (t.type==='income' ? t.amount : -t.amount), 0);
          return el('div', {},
            el('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '0 4px', marginBottom: '6px' } },
              el('span', { style: { fontSize: '12px', color: '#4B5563', fontWeight: '600', textTransform: 'capitalize' } }, new Date(date+'T12:00:00').toLocaleDateString('es-MX', { weekday: 'short', day: 'numeric', month: 'short' })),
              el('span', { style: { fontSize: '11px', fontWeight: '700', color: dayTot >= 0 ? '#34D399' : '#FF6B6B' } }, `${dayTot>=0?'+':''}${fmt(dayTot, state.currency)}`)
            ),
            el('div', { style: cardStyle },
              ...items.map((tx, idx) => {
                const cat = allCats.find(c => c.id === tx.category) || { icon: 'â“', name: '?', color: '#666' };
                return el('div', { className: 'tx-row', onClick: () => update({ modal: 'transaction', editTx: tx }), style: { display: 'flex', alignItems: 'center', padding: '10px 0', borderBottom: idx < items.length-1 ? '1px solid #1A1D27' : 'none', cursor: 'pointer', borderRadius: '8px', transition: 'background 0.1s' } },
                  el('div', { style: { width: '36px', height: '36px', borderRadius: '10px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '16px', background: cat.color+'15', marginRight: '10px', flexShrink: '0' } }, cat.icon),
                  el('div', { style: { flex: '1', minWidth: '0' } }, el('div', { style: { fontSize: '13px', color: '#E2E8F0', fontWeight: '500' } }, cat.name), ...(tx.note ? [el('div', { style: { fontSize: '11px', color: '#3B3F4E' } }, tx.note)] : [])),
                  el('div', { style: { fontSize: '14px', fontWeight: '700', color: tx.type==='income' ? '#34D399' : '#FF6B6B' } }, `${tx.type==='income'?'+':'-'}${fmt(tx.amount, tx.currency)}`)
                );
              })
            )
          );
        })
      );
    };

    // â”€â”€â”€ Transaction Modal (IMPROVED: bigger amount input, better flow) â”€â”€â”€
    const renderTransactionModal = () => {
      const editing = state.editTx;
      let type = editing?.type || 'expense', amount = editing?.amount?.toString() || '', category = editing?.category || '', currency = editing?.currency || state.currency, date = editing?.date || new Date().toISOString().split('T')[0], note = editing?.note || '';
      const form = el('div', {});
      const buildForm = () => {
        form.innerHTML = '';
        const cats = state.categories[type] || [];
        // Type toggle
        form.appendChild(el('div', { style: { display: 'flex', gap: '8px', marginBottom: '18px', background: '#1A1D27', borderRadius: '12px', padding: '4px' } },
          ...[['expense','Gasto','#FF6B6B'],['income','Ingreso','#34D399']].map(([t,label,color]) =>
            el('button', { onClick: () => { type = t; category = ''; buildForm(); }, style: { flex: '1', padding: '10px', borderRadius: '10px', border: 'none', cursor: 'pointer', background: type===t ? color+'18' : 'transparent', color: type===t ? color : '#4B5563', fontWeight: '700', fontSize: '14px', transition: 'all 0.15s' } }, label)
          )
        ));
        // Amount (BIG)
        const amountRow = el('div', { style: { display: 'flex', gap: '8px', marginBottom: '14px' } });
        const amtInput = el('input', { type: 'number', inputMode: 'decimal', placeholder: '0.00', style: { ...inputStyles, flex: '1', fontSize: '24px', fontWeight: '800', padding: '14px', letterSpacing: '-0.5px' } });
        amtInput.value = amount; amtInput.addEventListener('input', e => { amount = e.target.value; });
        const curSelect = el('select', { style: { ...inputStyles, width: '80px', textAlign: 'center', fontWeight: '600', cursor: 'pointer' } });
        Object.entries(CURRENCIES).forEach(([k,v]) => { const o = el('option', { value: k }, `${v.flag} ${k}`); if (k === currency) o.selected = true; curSelect.appendChild(o); });
        curSelect.addEventListener('change', e => { currency = e.target.value; });
        amountRow.appendChild(amtInput); amountRow.appendChild(curSelect);
        form.appendChild(amountRow);
        // Categories
        form.appendChild(el('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '8px', marginBottom: '14px' } },
          ...cats.map(c => el('button', { onClick: () => { category = c.id; buildForm(); }, style: { padding: '10px 4px', borderRadius: '12px', border: 'none', cursor: 'pointer', background: category===c.id ? c.color+'20' : '#1A1D27', outline: category===c.id ? `2px solid ${c.color}50` : '2px solid transparent', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px', transition: 'all 0.12s' } },
            el('span', { style: { fontSize: '22px' } }, c.icon),
            el('span', { style: { fontSize: '10px', color: category===c.id ? c.color : '#64748B', fontWeight: '600' } }, c.name)
          ))
        ));
        // Date
        const dateInput = el('input', { type: 'date', style: { ...inputStyles, marginBottom: '10px' } });
        dateInput.value = date; dateInput.addEventListener('change', e => { date = e.target.value; });
        form.appendChild(dateInput);
        // Note
        const noteInput = el('input', { placeholder: 'Nota (opcional)', style: { ...inputStyles, marginBottom: '20px' } });
        noteInput.value = note; noteInput.addEventListener('input', e => { note = e.target.value; });
        form.appendChild(noteInput);
        // Actions
        const actions = el('div', { style: { display: 'flex', gap: '8px' } });
        if (editing) { actions.appendChild(el('button', { onClick: () => { update({ transactions: state.transactions.filter(t => t.id !== editing.id), modal: null, editTx: null }); showToast('Eliminado'); autoSync(); }, style: { width: '48px', height: '48px', borderRadius: '14px', border: 'none', background: '#FF6B6B18', color: '#FF6B6B', cursor: 'pointer', fontSize: '20px', display: 'flex', alignItems: 'center', justifyContent: 'center' } }, 'ðŸ—‘')); }
        actions.appendChild(el('button', { onClick: () => update({ modal: null, editTx: null }), style: { flex: '1', padding: '14px', borderRadius: '14px', border: '1px solid #2A2D3A', background: 'transparent', color: '#94A3B8', cursor: 'pointer', fontSize: '14px', fontWeight: '600' } }, 'Cancelar'));
        actions.appendChild(el('button', { onClick: () => {
          if (!amount || !category) return;
          const tx = { type, amount: parseFloat(amount), category, currency, date, note };
          if (editing) { update({ transactions: state.transactions.map(t => t.id === editing.id ? { ...tx, id: editing.id } : t), modal: null, editTx: null }); showToast('Actualizado'); }
          else { update({ transactions: [...state.transactions, { ...tx, id: Date.now().toString() }], modal: null, editTx: null }); showToast('Agregado'); }
          autoSync();
        }, style: { flex: '2', padding: '14px', borderRadius: '14px', border: 'none', cursor: 'pointer', fontSize: '15px', fontWeight: '700', background: type==='expense' ? 'linear-gradient(135deg,#FF6B6B,#EE5A24)' : 'linear-gradient(135deg,#34D399,#059669)', color: '#fff', opacity: (!amount || !category) ? '0.35' : '1', transition: 'opacity 0.2s' } }, editing ? 'Guardar' : 'Agregar'));
        form.appendChild(actions);
      };
      buildForm();
      return renderModal(editing ? 'Editar Movimiento' : 'Nuevo Movimiento', form);
    };

    // â”€â”€â”€ Settings Modal â”€â”€â”€
    const renderSettingsModal = () => {
      const stats = { txs: state.transactions.length, rec: state.recurring.length, activeRec: state.recurring.filter(r => r.active).length, cats: state.categories.expense.length + state.categories.income.length, size: (new Blob([JSON.stringify(state)]).size / 1024).toFixed(1) };
      const section = (title, children) => el('div', { style: { background: '#1A1D27', borderRadius: '14px', padding: '16px', marginBottom: '12px', border: '1px solid #1E2030' } }, el('div', { style: { fontSize: '12px', color: '#64748B', fontWeight: '700', marginBottom: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' } }, title), ...children);
      const content = el('div', {},
        section('â˜ï¸ Google Drive', [
          el('div', { style: { fontSize: '12px', color: '#4B5563', marginBottom: '12px' } }, state.driveStatus === 'connected' ? `âœ… Conectado${state.lastSync ? ' Â· ' + new Date(state.lastSync).toLocaleString('es-MX') : ''}` : 'Respalda tus datos en la nube automÃ¡ticamente'),
          el('div', { style: { display: 'flex', gap: '8px' } },
            ...(state.driveStatus === 'connected' ? [
              el('button', { onClick: syncWithDrive, style: btnStyle('#22D3EE22', '#22D3EE', { flex: '1' }) }, 'ðŸ”„ Sincronizar'),
              el('button', { onClick: disconnectDrive, style: btnStyle('#FF6B6B22', '#FF6B6B', { flex: '1' }) }, 'Desconectar'),
            ] : [
              el('button', { onClick: connectDrive, style: btnStyle('linear-gradient(135deg, #22D3EE, #818CF8)', '#fff', { width: '100%', padding: '14px' }) }, state.driveStatus === 'connecting' ? 'â³ Conectando...' : 'ðŸ”— Conectar Google Drive'),
            ])
          ),
        ]),
        section('ðŸ“‚ Respaldo Local', [
          el('div', { style: { display: 'flex', gap: '8px' } },
            el('button', { onClick: () => { const blob = new Blob([JSON.stringify({ transactions: state.transactions, categories: state.categories, budgets: state.budgets, recurring: state.recurring, exportedAt: new Date().toISOString(), app: 'Finanxas' }, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `finanxas_${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(a.href); showToast('Exportado'); }, style: btnStyle('#34D39922', '#34D399', { flex: '1' }) }, 'ðŸ“¤ Exportar'),
            (() => { const label = el('label', { style: { ...btnStyle('#60A5FA22', '#60A5FA', { flex: '1' }), textAlign: 'center', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' } }, 'ðŸ“¥ Importar'); const fi = el('input', { type: 'file', accept: '.json', style: { display: 'none' } }); fi.addEventListener('change', e => { const f = e.target.files?.[0]; if (!f) return; const r = new FileReader(); r.onload = ev => { try { const d = JSON.parse(ev.target.result); if (d.transactions) { update({ transactions: d.transactions, categories: d.categories || state.categories, budgets: d.budgets || state.budgets, recurring: d.recurring || state.recurring, modal: null }); showToast(`${d.transactions.length} registros importados`); } } catch { showToast('Archivo invÃ¡lido', 'error'); } }; r.readAsText(f); }); label.appendChild(fi); return label; })()
          ),
        ]),
        section('ðŸ“Š Info', [
          el('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' } },
            ...[{ l: 'Registros', v: stats.txs }, { l: 'Recurrentes', v: `${stats.activeRec}/${stats.rec}` }, { l: 'CategorÃ­as', v: stats.cats }, { l: 'Datos', v: `${stats.size} KB` }].map(s => el('div', { style: { padding: '10px', borderRadius: '10px', background: '#13151E' } }, el('div', { style: { fontSize: '10px', color: '#4B5563' } }, s.l), el('div', { style: { fontSize: '15px', fontWeight: '700', color: '#E2E8F0', marginTop: '2px' } }, String(s.v))))
          )
        ]),
        section('âš ï¸ Borrar datos', [
          el('button', { onClick: () => { if (confirm('Â¿Borrar TODO permanentemente?')) { update({ transactions: [], categories: DEFAULT_CATEGORIES, budgets: {}, recurring: [], modal: null }); showToast('Datos eliminados'); } }, style: { width: '100%', padding: '12px', borderRadius: '12px', border: '1px solid #FF6B6B33', background: '#FF6B6B10', color: '#FF6B6B', fontWeight: '600', fontSize: '13px', cursor: 'pointer' } }, 'Borrar todo')
        ]),
        el('div', { style: { textAlign: 'center', padding: '8px 0', color: '#1E2030', fontSize: '11px' } }, 'Finanxas v2.1')
      );
      return renderModal('âš™ï¸ Ajustes', content);
    };

    // â”€â”€â”€ Recurring Modal â”€â”€â”€
    const renderRecurringModal = () => {
      let showForm = false;
      const allCats = [...state.categories.expense, ...state.categories.income];
      const content = el('div', {});
      let formType = 'expense', formAmount = '', formCat = '', formCur = state.currency, formFreq = 'monthly', formDate = new Date().toISOString().split('T')[0], formNote = '';
      const buildContent = () => {
        content.innerHTML = '';
        if (!showForm) {
          content.appendChild(el('button', { onClick: () => { showForm = true; buildContent(); }, style: { ...btnStyle('#22D3EE20', '#22D3EE'), width: '100%', padding: '12px', marginBottom: '16px', textAlign: 'center' } }, '+ Agregar recurrente'));
          if (state.recurring.length === 0) {
            content.appendChild(el('div', { style: { textAlign: 'center', padding: '24px 0' } }, el('div', { style: { fontSize: '36px', marginBottom: '6px' } }, 'ðŸ”„'), el('div', { style: { fontSize: '13px', color: '#3B3F4E' } }, 'Agrega renta, Netflix, salario, etc.')));
          } else {
            state.recurring.forEach(r => {
              const cat = allCats.find(c => c.id === r.category) || { icon: 'â“', name: '?', color: '#666' };
              const fl = FREQUENCIES.find(f => f.id === r.frequency)?.label || r.frequency;
              content.appendChild(el('div', { style: { display: 'flex', alignItems: 'center', padding: '12px 0', borderBottom: '1px solid #1A1D27', opacity: r.active ? '1' : '0.4' } },
                el('div', { style: { width: '38px', height: '38px', borderRadius: '10px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '18px', background: cat.color+'15', marginRight: '10px', flexShrink: '0' } }, cat.icon),
                el('div', { style: { flex: '1', minWidth: '0' } }, el('div', { style: { fontSize: '13px', color: '#E2E8F0', fontWeight: '500' } }, r.note), el('div', { style: { fontSize: '11px', color: '#3B3F4E' } }, `${fl} Â· ${fmt(r.amount, r.currency)}`)),
                el('button', { onClick: () => { update({ recurring: state.recurring.map(x => x.id === r.id ? { ...x, active: !x.active } : x) }); buildContent(); autoSync(); }, style: { background: 'none', border: 'none', cursor: 'pointer', fontSize: '16px', padding: '8px' } }, r.active ? 'â¸' : 'â–¶ï¸'),
                el('button', { onClick: () => { update({ recurring: state.recurring.filter(x => x.id !== r.id) }); showToast('Eliminado'); buildContent(); autoSync(); }, style: { background: 'none', border: 'none', cursor: 'pointer', fontSize: '14px', padding: '8px', color: '#3B3F4E' } }, 'âœ•')
              ));
            });
          }
        } else {
          const cats = state.categories[formType] || [];
          content.appendChild(el('div', { style: { display: 'flex', gap: '8px', marginBottom: '14px', background: '#1A1D27', borderRadius: '12px', padding: '4px' } },
            ...[['expense','Gasto','#FF6B6B'],['income','Ingreso','#34D399']].map(([t,l,c]) => el('button', { onClick: () => { formType = t; formCat = ''; buildContent(); }, style: { flex: '1', padding: '10px', borderRadius: '10px', border: 'none', cursor: 'pointer', background: formType===t?c+'18':'transparent', color: formType===t?c:'#4B5563', fontWeight: '700', fontSize: '14px' } }, l))
          ));
          const noteIn = el('input', { placeholder: 'Nombre (ej: Netflix, Renta)', style: { ...inputStyles, marginBottom: '10px' } }); noteIn.value = formNote; noteIn.addEventListener('input', e => { formNote = e.target.value; }); content.appendChild(noteIn);
          const amtRow = el('div', { style: { display: 'flex', gap: '8px', marginBottom: '12px' } });
          const amtIn = el('input', { type: 'number', inputMode: 'decimal', placeholder: 'Monto', style: { ...inputStyles, flex: '1', fontWeight: '700' } }); amtIn.value = formAmount; amtIn.addEventListener('input', e => { formAmount = e.target.value; });
          const curSel = el('select', { style: { ...inputStyles, width: '80px' } }); Object.entries(CURRENCIES).forEach(([k,v]) => { const o = el('option', { value: k }, `${v.flag} ${k}`); if (k===formCur) o.selected = true; curSel.appendChild(o); }); curSel.addEventListener('change', e => { formCur = e.target.value; });
          amtRow.appendChild(amtIn); amtRow.appendChild(curSel); content.appendChild(amtRow);
          content.appendChild(el('div', { style: { fontSize: '12px', color: '#4B5563', marginBottom: '6px', fontWeight: '600' } }, 'Frecuencia'));
          content.appendChild(el('div', { style: { display: 'flex', gap: '6px', flexWrap: 'wrap', marginBottom: '14px' } }, ...FREQUENCIES.map(f => el('button', { onClick: () => { formFreq = f.id; buildContent(); }, style: { padding: '8px 16px', borderRadius: '20px', border: 'none', cursor: 'pointer', fontSize: '13px', fontWeight: '600', background: formFreq===f.id?'#22D3EE20':'#1A1D27', color: formFreq===f.id?'#22D3EE':'#64748B' } }, f.label))));
          content.appendChild(el('div', { style: { fontSize: '12px', color: '#4B5563', marginBottom: '6px', fontWeight: '600' } }, 'CategorÃ­a'));
          content.appendChild(el('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '8px', marginBottom: '14px' } }, ...cats.map(c => el('button', { onClick: () => { formCat = c.id; buildContent(); }, style: { padding: '8px 4px', borderRadius: '10px', border: 'none', cursor: 'pointer', background: formCat===c.id?c.color+'20':'#1A1D27', outline: formCat===c.id?`2px solid ${c.color}50`:'none', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '3px' } }, el('span', { style: { fontSize: '18px' } }, c.icon), el('span', { style: { fontSize: '9px', color: formCat===c.id?c.color:'#64748B' } }, c.name)))));
          content.appendChild(el('div', { style: { display: 'flex', gap: '8px' } },
            el('button', { onClick: () => { showForm = false; buildContent(); }, style: { flex: '1', padding: '14px', borderRadius: '14px', border: '1px solid #2A2D3A', background: 'transparent', color: '#94A3B8', cursor: 'pointer', fontWeight: '600' } }, 'Cancelar'),
            el('button', { onClick: () => { if (!formAmount || !formCat || !formNote) return; update({ recurring: [...state.recurring, { id: Date.now().toString(), type: formType, amount: parseFloat(formAmount), category: formCat, currency: formCur, frequency: formFreq, startDate: formDate, note: formNote, active: true, lastApplied: null }] }); showToast('Recurrente creado'); showForm = false; formAmount = ''; formCat = ''; formNote = ''; buildContent(); autoSync(); }, style: { flex: '2', padding: '14px', borderRadius: '14px', border: 'none', cursor: 'pointer', fontWeight: '700', background: 'linear-gradient(135deg, #22D3EE, #818CF8)', color: '#fff', opacity: (!formAmount||!formCat||!formNote)?'0.35':'1' } }, 'Crear')
          ));
        }
      };
      buildContent();
      return renderModal('ðŸ”„ Recurrentes', content);
    };

    // â”€â”€â”€ Bottom Nav (SIMPLIFIED: 4 items + FAB) â”€â”€â”€
    const renderNav = () => {
      const navBtn = (icon, label, active, action) => el('button', { onClick: action, style: { flex: '1', padding: '6px 0', borderRadius: '12px', border: 'none', cursor: 'pointer', background: 'transparent', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '2px' } },
        el('span', { style: { fontSize: '22px', filter: active ? 'none' : 'grayscale(0.7) opacity(0.5)' } }, icon),
        el('span', { style: { fontSize: '9px', fontWeight: '700', color: active ? '#22D3EE' : '#2A2D3A' } }, label)
      );
      return el('div', { style: { position: 'fixed', bottom: '0', left: '0', right: '0', background: 'linear-gradient(180deg, transparent 0%, #0B0D14 25%)', padding: '8px 12px calc(env(safe-area-inset-bottom, 8px) + 4px)', zIndex: '100' } },
        el('div', { style: { display: 'flex', alignItems: 'center', gap: '4px', maxWidth: '420px', margin: '0 auto' } },
          navBtn('ðŸ“Š', 'Inicio', state.view === 'dashboard', () => update({ view: 'dashboard' })),
          navBtn('ðŸ“‹', 'Registros', state.view === 'transactions', () => update({ view: 'transactions' })),
          el('button', { onClick: () => update({ modal: 'transaction', editTx: null }), style: { width: '56px', height: '56px', borderRadius: '18px', border: 'none', cursor: 'pointer', background: 'linear-gradient(135deg, #22D3EE, #818CF8)', color: '#fff', fontSize: '28px', fontWeight: '300', display: 'flex', alignItems: 'center', justifyContent: 'center', boxShadow: '0 4px 24px rgba(34,211,238,0.35)', margin: '0 8px', flexShrink: '0' } }, '+'),
          navBtn('ðŸ”„', 'Recurr.', false, () => update({ modal: 'recurring' })),
          navBtn('âš™ï¸', 'Ajustes', false, () => update({ modal: 'settings' }))
        )
      );
    };

    // â”€â”€â”€ Main Render â”€â”€â”€
    const render = () => {
      const app = document.getElementById('app');
      app.innerHTML = '';
      app.appendChild(renderHeader());
      const content = el('div', { style: { padding: '6px 16px 110px' } });
      if (state.view === 'dashboard') content.appendChild(renderDashboard());
      else content.appendChild(renderTransactions());
      app.appendChild(content);
      app.appendChild(renderNav());
      if (state.toast) app.appendChild(renderToast());
      if (state.modal === 'transaction') app.appendChild(renderTransactionModal());
      if (state.modal === 'settings') app.appendChild(renderSettingsModal());
      if (state.modal === 'recurring') app.appendChild(renderRecurringModal());
    };

    // â”€â”€â”€ Init â”€â”€â”€
    state = initState();
    document.getElementById('loading').style.display = 'none';
    render();
    GDrive.init().then(ready => { if (ready && GDrive.accessToken) update({ driveStatus: 'connected' }); });
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('/finanxas/sw.js').catch(() => {});
  </script>
</body>
</html>
